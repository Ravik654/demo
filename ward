import { Test, TestingModule } from '@nestjs/testing';

import { Readable } from 'stream';

import { ContentManagerRetrievalService } from '../retrieval.service';
 
describe('ContentManagerRetrievalService', () => {

  let service: ContentManagerRetrievalService;
 
  const mockHttpService = {

    getStream: jest.fn(),

  };
 
  beforeEach(async () => {

    const module: TestingModule = await Test.createTestingModule({

      providers: [

        ContentManagerRetrievalService,

        {

          provide: 'HttpServiceAlias', // <-- replace with your actual provider token

          useValue: mockHttpService,

        },

      ],

    }).compile();
 
    service = module.get<ContentManagerRetrievalService>(

      ContentManagerRetrievalService,

    );
 
    // mock logger

    service.logger = {

      log: jest.fn(),

      error: jest.fn(),

      warn: jest.fn(),

      debug: jest.fn(),

      verbose: jest.fn(),

    } as any;

  });
 
  describe('retrieveDocument', () => {

    it('should log the correct message and return a readable stream', async () => {

      const id = '12345';

      const contentType = 'application/pdf';
 
      // Create a mock Readable stream

      const mockStream = new Readable({

        read() {

          this.push('test');

          this.push(null);

        },

      });
 
      // mock underlying call

      mockHttpService.getStream.mockResolvedValue(mockStream);
 
      // Act

      const result = await service.retrieveDocument(id, contentType);
 
      // Assert logger behavior

      expect(service.logger.log).toHaveBeenCalledWith(

        `Retrieve Content from Content Manager with Content Type ${contentType} and ID: ${id}`,

      );
 
      // Assert underlying method call

      expect(mockHttpService.getStream).toHaveBeenCalledWith(id, contentType);
 
      // Assert returned value

      expect(result).toBe(mockStream);

    });
 
    it('should propagate errors thrown by http service', async () => {

      const id = '987';

      const contentType = 'application/json';
 
      mockHttpService.getStream.mockRejectedValue(

        new Error('test error'),

      );
 
      await expect(

        service.retrieveDocument(id, contentType),

      ).rejects.toThrow('test error');

    });

  });

});

 
